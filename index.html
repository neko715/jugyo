<script>
    const timeOffset = 5; // 5秒進める固定調整
    let showElapsedTime = false; // 経過時間の表示フラグ

    // スケジュール定義
    const baseSchedule = [
        { period: '朝の会', start: '8:10', end: '8:20' },
        { period: 'スキル・読書', start: '8:20', end: '8:35' },
        { period: '1時間目', start: '8:40', end: '9:25' },
        { period: '2時間目', start: '9:30', end: '10:15' },
        { period: '業間休み', start: '10:15', end: '10:30' },
        { period: '3時間目', start: '10:35', end: '11:20' },
        { period: '4時間目', start: '11:25', end: '12:10' },
        { period: '昼食', start: '12:10', end: '12:55' },
        { period: '昼休み', start: '12:55', end: '13:15' },
        { period: '5時間目', start: '13:40', end: '14:25' },
        { period: '6時間目', start: '14:30', end: '15:15' },
    ];

    const shortNoLunchSchedule = [
        { period: '朝の会', start: '8:10', end: '8:20' },
        { period: '1時間目', start: '8:25', end: '9:10' },
        { period: '2時間目', start: '9:15', end: '10:00' },
        { period: '業間休み', start: '10:00', end: '10:05' },
        { period: '3時間目', start: '10:10', end: '10:55' },
        { period: '4時間目', start: '11:00', end: '11:55' },
    ];

    const shortWithLunchSchedule = [
        { period: '朝の会', start: '8:10', end: '8:20' },
	{ period: 'スキル・読書', start: '8:20', end: '8:35' },
        { period: '1時間目', start: '8:40', end: '9:25' },
        { period: '2時間目', start: '9:30', end: '10:15' },
        { period: '業間休み', start: '10:15', end: '10:20' },
        { period: '3時間目', start: '10:25', end: '11:10' },
        { period: '4時間目', start: '11:15', end: '12:00' },
        { period: '昼食', start: '12:00', end: '12:45' },
    ];

    let currentSchedule = baseSchedule;

    function parseTime(time) {
        const [hours, minutes] = time.split(':').map(Number);
        const now = new Date();
        return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
    }

    function formatTime(date) {
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    function getStatus(schedule) {
        const now = new Date(new Date().getTime() + timeOffset * 1000);

        for (let i = 0; i < schedule.length; i++) {
            const period = schedule[i];
            const start = parseTime(period.start);
            const end = parseTime(period.end);

            if (now >= start && now <= end) {
                const elapsedTime = Math.max(0, Math.round((now - start) / 1000));
                const elapsedMinutes = Math.floor(elapsedTime / 60);
                const elapsedSeconds = elapsedTime % 60;

                const remainingTime = Math.max(0, Math.round((end - now) / 1000));
                const remainingMinutes = Math.floor(remainingTime / 60);
                const remainingSeconds = remainingTime % 60;

                let status = `${period.period}中です。あと<strong>${remainingMinutes}分${remainingSeconds}秒</strong>で終了します（${formatTime(end)}に終了）。`;

                if (showElapsedTime) {
                    status += `<br>開始から<strong>${elapsedMinutes}分${elapsedSeconds}秒</strong>経過しました。`;
                }

                return status;
            } else if (now < start) {
                const remainingTime = Math.max(0, Math.round((start - now) / 1000));
                const remainingMinutes = Math.floor(remainingTime / 60);
                const remainingSeconds = remainingTime % 60;
                return `${period.period}はあと<strong>${remainingMinutes}分${remainingSeconds}秒</strong>で開始します（${formatTime(start)}に開始）。`;
            }
        }
        return '現在、授業時間外です。';
    }

    function updateStatuses() {
        document.getElementById('normal-status').innerHTML = getStatus(currentSchedule);
        document.getElementById('short-no-lunch-status').innerHTML = getStatus(shortNoLunchSchedule);
        document.getElementById('short-with-lunch-status').innerHTML = getStatus(shortWithLunchSchedule);
    }

    document.getElementById('elapsed-time-toggle').addEventListener('click', () => {
        showElapsedTime = !showElapsedTime;
        document.getElementById('elapsed-time-toggle').classList.toggle('on', showElapsedTime);
        updateStatuses();
    });

    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            document.querySelectorAll('.content').forEach(content => {
                content.classList.remove('active');
            });

            const targetContent = document.getElementById(button.dataset.target);
            targetContent.classList.add('active');

            if (button.dataset.target === 'normal') {
                currentSchedule = baseSchedule;
            } else if (button.dataset.target === 'short-no-lunch') {
                currentSchedule = shortNoLunchSchedule;
            } else if (button.dataset.target === 'short-with-lunch') {
                currentSchedule = shortWithLunchSchedule;
            }
            updateStatuses();
        });
    });

    document.querySelector('.tab-button').click();
    updateStatuses();
    setInterval(updateStatuses, 1000);
</script>
